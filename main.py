import json

from fastapi import FastAPI
from fastapi.responses import StreamingResponse
import uvicorn

app = FastAPI()


@app.get("/")
async def root():
    return {"message": "Hello World"}


@app.get("/stream_demo")
async def stream_demo():
    """
    流式传输演示接口
    
    此接口模拟了一个流式传输的完整过程，展示了如何使用FastAPI的StreamingResponse
    来实现实时数据推送功能。主要用于演示旅行计划生成过程中的各个步骤信息推送，
    包括查询、搜索、生成等阶段的状态更新。
    
    每条消息都包含了聊天ID、消息ID、角色、内容、时间戳和状态等信息，
    客户端可以通过SSE(Server-Sent Events)方式接收这些实时更新的数据。
    
    Returns:
        StreamingResponse: 返回一个持续推送JSON数据的流式响应
    """
    import asyncio

    async def generate_content():
        messages = [
            {
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "role": "system",
                "content": "1.开始处理您的旅行请求...\n\n",
                "timestamp": "2025-04-22T18:14:26.281744",
                "status": "start"
            },
            {
                "content": "## 🔍 开始执行旅行信息查询\n\n正在根据您的需求生成旅行查询列表，这将帮助我获取相关旅行信息...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:14:26.281793",
                "status": "running"
            },
            {
                "content": "## ✅ 查询列表生成完成\n\n**查询描述**：将针对深圳出发，5月1日到丽江，行程4天，5月5日从昆明返程的旅游计划进行攻略、交通、景点、美食、手信和注意事项的全面查询。\n\n已生成 **8** 个查询，包括：\n- 丽江旅游攻略\n- 深圳到丽江的交通方式查询（飞机/高铁/自驾）\n- 丽江必去景点TOP10\n- *及其他 5 个查询...*\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:14:37.187501",
                "status": "running"
            },
            {
                "content": "## 🌐 执行网络搜索\n\n正在根据生成的查询列表搜索互联网，获取相关旅行信息...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:14:37.187712",
                "status": "running"
            },
            {
                "content": "## ✅ 网络搜索完成\n\n已完成 **8** 个查询的搜索，获取了大量相关信息用于制定您的旅行计划。\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:14:42.076150",
                "status": "running"
            },
            {
                "content": "## 📝 生成旅行行程草稿\n\n正在根据搜集的信息生成您的旅行行程初稿，包括景点安排、时间规划等...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:14:42.076352",
                "status": "running"
            },
            {
                "content": "<think>\n好的，我现在要帮用户规划从深圳到丽江，4天行程，然后从昆明返回的旅行计划。首先，我需要理清楚用户的具体需求和时间安排。用户是5月1日出发，5月5日从昆明回来，所以总共有5天的时间，但实际游玩时间是4天，因为最后一天要从昆明离开。\n\n首先，我需要确定交通方式。用户从深圳到丽江，返回是从昆明到深圳。根据之前的信息，深圳到丽江最快的交通方式是飞机，航班频繁，但价格较高。高铁和自驾时间较长，可能不太适合4天的行程。然后，从丽江到昆明，用户需要选择交通方式，同样飞机最便宜，火车或大巴更便宜但耗时更长。最后从昆明回深圳，用户可以选择飞机或高铁，飞机更便宜，大约12小时，高铁8小时左右，自驾可能不太现实，因为距离太远。\n\n接下来，我需要安排每天的行程。丽江的主要景点包括丽江古城、玉龙雪山、束河古镇、拉市海、虎跳峡等。用户有4天时间，可能需要合理分配这些景点，避免行程太赶。同时还要考虑从丽江到昆明的交通时间，可能需要最后一天从丽江前往昆明，然后从昆明返回深圳。\n\n另外，需要注意5月是丽江的春季，天气可能比较干燥，紫外线强，需要提醒用户注意防晒和保暖。此外，丽江的海拔较高，比如玉龙雪山可能会有高原反应，需要提前准备。\n\n在美食方面，用户可能想品尝当地特色，比如腊排骨火锅、烤鱼、米线等，可以在行程中安排推荐餐厅。购物方面，可以推荐雪花银首饰、东巴纸等手信。\n\n然后，我需要检查时间安排的合理性。比如第一天从深圳飞丽江，抵达后游览丽江古城，第二天去玉龙雪山，第三天去束河古镇和拉市海，第四天可能安排虎跳峡一日游，然后晚上或第五天早上前往昆明，最后从昆明飞回深圳。\n\n还需要考虑交通衔接，比如丽江到昆明的交通时间，如果坐飞机大约1小时，火车可能需要3-4小时，但实际可能需要更长时间，因为丽江到昆明的高铁可能需要绕道大理，所以时间会更长，可能需要7小时左右。因此，可能需要提前一天晚上或第五天早上出发前往昆明，以确保赶上回深圳的航班。\n\n最后，预算方面，用户可能需要考虑交通、住宿、门票和餐饮费用，给出一个大概的预算范围，供用户参考。\n\n可能还需要提醒用户提前预订机票和住宿，尤其是五一期间可能比较繁忙，价格也会上涨。此外，玉龙雪山的门票可能需要提前预约，特别是大索道的票，因为限量供应。\n\n总结下来，行程需要紧凑但合理，涵盖主要景点，交通衔接顺畅，注意事项和预算提醒到位。\n</think>\n\n## ✅ 旅行行程初稿已生成\n\n已根据您的需求和收集的信息整理出行程草案，接下来将开始搜索具体的交通、住宿和景点详情。\n\n# 五一深圳—丽江—昆明4日探索之旅草稿\n\n## 行程概览\n- **出发日期**：2025年5月1日\n- **返程日期**：2025年5月5日\n- **行程天数**：4天\n- **出发地**：深圳\n- **目的地**：丽江（终点：昆明）\n- **主要交通方式**：深圳至丽江建议乘坐飞机；丽江至昆明可选飞机或高铁；昆明返回深圳可选飞机或高铁\n\n---\n\n## 每日行程安排\n\n### **Day 1：5月1日（星期四）**\n- **上午**：从深圳出发，前往深圳机场，办理登机手续，搭乘飞往丽江的航班。\n- **下午**：抵达丽江三义机场后，前往预订住宿区域（丽江古城区或束河古镇），安顿行李，入住酒店。稍作休息后，开始游览丽江古城（世界文化遗产），漫步四方街、木府，欣赏古城风光。\n- **晚上**：畅游丽江古城夜景，可在古城内品尝当地小吃，体验纳西族古乐表演。\n\n**交通建议**：深圳—丽江：建议乘坐直飞航班；机场至市区可打车或乘坐机场大巴。\n**住宿建议**：建议住丽江古城区内或束河古镇周边，方便夜间出行。酒店类型可选特色客栈或舒适型酒店。\n**用餐建议**：午餐建议在飞机或机场简餐。晚餐可选择丽江古城中的腊排骨火锅、云南米线、石锅鸡等特色美食。\n\n---\n\n### **Day 2：5月2日（星期五）**\n- **上午**：早餐后，前往玉龙雪山景区（建议提前预订索道票），游览蓝月谷、冰川公园等主要景点，可以选择根据体力情况游玩玉龙雪山主峰下雪景。\n- **下午**：参观白沙古镇，欣赏纳西壁画，顺路可游览文笔山、拉什海湿地（可骑马感受纳西风情）。\n- **晚上**：返回丽江古城，休息或自由活动，可体验古城特色酒吧文化或步行赏夜色。\n\n**交通建议**：市内包车/拼车一日游或跟团前往玉龙雪山（可在酒店前台或旅行社预约），市内及周边交通以拼车/打车为主。\n**住宿建议**：继续建议住丽江古城区或客栈。\n**用餐建议**：早餐可在酒店用餐，午餐建议在玉龙雪山附近简餐。晚餐可在古城内尝试烤鱼、烤乳扇等特色风味。\n\n---\n\n### **Day 3：5月3日（星期六）**\n- **上午**：早餐后前往束河古镇，感受少数民族风情和安静古镇生活；也可选择游览虎跳峡（适合体力较好者）、赏长江第一湾壮观景色。\n- **下午**：参观拉市海湿地，骑马体验“茶马古道”风情，或乘船赏湖景。时间充裕可顺便拜访其他周边小镇如大研古镇、老君山自然保护区等。\n- **晚上**：返回丽江市区，整理行李，享受丽江最后一晚的悠闲时光。\n\n**交通建议**：市区短途建议打车或租车，远程建议参加一日游团或包车。\n**住宿建议**：建议仍住丽江古城区或束河古镇。\n**用餐建议**：午餐可在束河古镇品尝云南土鸡火锅、傣族风味小吃。晚餐建议尝试当地米线或云南火锅。\n\n---\n\n### **Day 4：5月4日（星期日）**\n- **上午**：早餐后退房，搭乘飞机或高铁前往昆明，预计中午或下午抵达。\n- **下午**：到达昆明后，前往市区入住酒店，短暂休息后可游览翠湖公园、金马碧鸡坊等昆明市区地标景点。\n- **晚上**：可在昆明南屏步行街逛街、品尝昆明小吃，或参观云南民族村感受多元文化。\n\n**交通建议**：丽江—昆明：建议飞机或高铁（按返程计划预订时间即可）；昆明交通以地铁/出租为主。\n**住宿建议**：建议住昆明市区（如翠湖/南屏街/火车站周边），便于出行；可选商务型或经济型酒店。\n**用餐建议**：早餐在丽江用餐，午餐建议在昆明接待站或周边餐馆酌情。晚餐可品尝昆明过桥米线、汽锅鸡等特色。\n\n---\n\n### **Day 5：5月5日（星期一）**\n- **上午**：根据返程航班或高铁时间办理退房；如时间充裕可选择前往昆明花市或购买云南特产（如鲜花饼、普洱茶、银器、东巴纸等）。\n- **下午**：前往昆明机场或火车站，搭乘返程交通返回深圳，愉快结束云南旅程。\n- **晚上**：在路上或已返抵深圳，回家休息。\n\n**交通建议**：昆明—深圳：建议提前预订直飞航班或高铁。昆明市区—机场/高铁站可打车或乘坐机场大巴、地铁。\n**住宿建议**：返程，无须住宿。\n**用餐建议**：早餐在昆明用餐，午餐可在机场或高铁站简餐，晚餐抵达深圳后自理。\n\n---\n\n## 必备物品清单\n1. 身份证/护照/必要证件\n2. 手机及充电器/充电宝\n3. 银行卡/适量现金\n4. 防晒霜、太阳镜、遮阳帽、润唇膏\n5. 适合春季的衣物（短袖+薄外套，早晚温差大）\n6. 雨伞或雨衣\n7. 常备药品（感冒药、肠胃药、抗高反药物）\n8. 个人洗漱用品\n9. 口罩及消毒湿巾\n10. 相机/拍照设备\n11. 插头转换器（如需）\n12. 旅行保险单据\n\n---\n\n## 旅行提示与建议\n1. 云南昼夜温差大，注意增减衣物，特别是山上、早晚多加件外套。\n2. 高海拔地区（如玉龙雪山）需适应气候，避免剧烈运动，体力不支者可提前准备抗高反药物。\n3. 强烈紫外线，务必做好防晒措施。\n4. 尊重当地少数民族（如纳西族）风俗习惯，注意不在水源丢弃垃圾和随意拍照。\n5. 提前预订热门景区门票和索道票，避免现场排队耽误时间。\n6. 慎选低价旅行团，以免遇到不诚信购物陷阱。\n7. 随身携带少量现金，绝大部分商家支持移动支付。\n8. 注意饮食卫生，品尝新食物适量为宜，避免水土不服。\n9. 妥善保管证件与贵重物品，警惕扒手。\n10. 建议购买适合的旅行保险，保障行程意外风险。\n11. 留意天气预报及当地实时天气变化，山区雨季需注意防雷防滑。\n\n---\n\n**备注**：本行程为初步草稿，具体航班、车次、酒店及门票信息请由后续专家进一步查询并预定。节假日出行请尤其关注交通和景区客流高峰。\n\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:26.882986",
                "status": "running"
            },
            {
                "content": "## ✈️ 搜索航班信息\n\n正在为您的行程构建航班查询列表，准备搜索最适合的航班选项...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:26.883158",
                "status": "running"
            },
            {
                "content": "## ✅ 航班查询列表已生成\n\n已生成 **3** 个航班查询需求，包括：\n- SZX → TAO，日期：2025-05-01，\n- TAO → LJG 日期：2025-05-01，\n- KMG → SZX，日期：2025-05-05\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:33.166948",
                "status": "running"
            },
            {
                "content": "## 🔍 查询航班信息\n\n正在搜索航空公司数据库，获取符合您行程的航班信息，包括价格、时间、经停等...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:33.167099",
                "status": "running"
            },
            {
                "content": "## ✅ 航班信息查询完成\n\n已找到 **8** 个符合条件的航班选项。这些信息将被整合到您的最终行程中。\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:34.020048",
                "status": "running"
            },
            {
                "content": "## 🏨 搜索酒店信息\n\n正在为您的行程目的地构建酒店查询列表，准备查找最适合的住宿选择...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:34.020235",
                "status": "running"
            },
            {
                "content": "## ✅ 酒店查询列表已生成\n\n已生成 **2** 个酒店查询需求，包括：\n- 丽江，入住：2025-05-01，住宿：3天\n- 昆明，入住：2025-05-04，住宿：1天\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:38.984198",
                "status": "running"
            },
            {
                "content": "## 🔍 查询酒店信息\n\n正在搜索酒店数据库，获取符合您需求的住宿信息，包括价格、设施、位置等...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:38.984388",
                "status": "running"
            },
            {
                "content": "## ✅ 酒店信息查询完成\n\n已找到 **10** 个符合条件的酒店选项。每个目的地都有多个不同价位和评价的选择，将为您精选最佳选项。\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:39.438839",
                "status": "running"
            },
            {
                "content": "## 🗿 搜索景点信息\n\n正在为您的旅行目的地构建景点查询列表，准备发掘最值得游览的景点和体验...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:39.439043",
                "status": "running"
            },
            {
                "content": "## ✅ 景点查询列表已生成\n\n已生成 **11** 个景点查询需求，包括：\n- 中国, 丽江, 丽江古城，语言：zh-cn\n- 中国, 丽江, 木府，语言：zh-cn\n- *及其他 9 个景点查询...*\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:46.298363",
                "status": "running"
            },
            {
                "content": "## 🔍 查询景点信息\n\n正在搜索旅游数据库，获取目的地的热门景点、活动和体验，包括开放时间、门票价格、游览建议等...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:46.298708",
                "status": "running"
            },
            {
                "content": "## ✅ 景点信息查询完成\n\n已找到 **11** 个值得游览的景点和活动。这些信息将根据位置和您的兴趣点整合到行程中。\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:55.029876",
                "status": "running"
            },
            {
                "content": "## 📊 整合最终旅行计划\n\n正在将所有收集的信息（行程草案、航班、酒店、景点）整合为一份完整的旅行计划...\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:15:55.030011",
                "status": "running"
            },
            {
                "content": "## ✅ 旅行计划整合完成\n\n已将所有信息整合为一份完整的旅行计划，包括详细的行程安排、交通方案、住宿信息和景点推荐。\n\n",
                "role": "system",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "timestamp": "2025-04-22T18:16:32.111376",
                "status": "running"
            },
            {
                "content": "",
                "chat_id": "4db40530-b10a-4e80-940d-212a10e272aa",
                "message_id": "4015e0e9-e559-43f2-b93c-4693960b9cb5",
                "role": "system",
                "status": "done",
                "timestamp": "2025-04-22T18:16:32.111788"
            }
        ]

        for message in messages:
            message = json.dumps(message, ensure_ascii=False)
            yield f"data: {message}\n\n"
            await asyncio.sleep(0.2)  # 模拟延迟，让流式效果更明显
        # 可选：发送结束标记
        # yield "data: [DONE]\n\n"
    return StreamingResponse(generate_content(), media_type="text/event-stream")


if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)

